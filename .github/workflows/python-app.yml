name: Update solved.ac Stats

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ(KST)ì— ì‹¤í–‰ (UTC 0ì‹œ)
    - cron: '0 0 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Fetch and pull latest changes
        run: |
          git fetch --all
          git pull origin main

      - name: Get solved.ac user info
        id: solvedac
        run: |
          # BOJ ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
          BOJ_USERNAME="rladydgnj"
          
          # solved.ac APIì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          USER_INFO=$(curl -s "https://solved.ac/api/v3/user/show?handle=${BOJ_USERNAME}")
          
          # í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
          TIER=$(echo $USER_INFO | jq -r '.tier')
          SOLVED_COUNT=$(echo $USER_INFO | jq -r '.solvedCount')
          RANK=$(echo $USER_INFO | jq -r '.rank')
          
          # í‹°ì–´ ì´ë¦„ ë§¤í•‘
          if [ "$TIER" -eq "0" ]; then
            TIER_NAME="Unrated"
          elif [ "$TIER" -le "5" ]; then
            TIER_NAMES=("" "Bronze V" "Bronze IV" "Bronze III" "Bronze II" "Bronze I")
            TIER_NAME="${TIER_NAMES[$TIER]}"
          elif [ "$TIER" -le "10" ]; then
            TIER_NAMES=("" "Silver V" "Silver IV" "Silver III" "Silver II" "Silver I")
            TIER_NAME="${TIER_NAMES[$TIER-5]}"
          elif [ "$TIER" -le "15" ]; then
            TIER_NAMES=("" "Gold V" "Gold IV" "Gold III" "Gold II" "Gold I")
            TIER_NAME="${TIER_NAMES[$TIER-10]}"
          elif [ "$TIER" -le "20" ]; then
            TIER_NAMES=("" "Platinum V" "Platinum IV" "Platinum III" "Platinum II" "Platinum I")
            TIER_NAME="${TIER_NAMES[$TIER-15]}"
          elif [ "$TIER" -le "25" ]; then
            TIER_NAMES=("" "Diamond V" "Diamond IV" "Diamond III" "Diamond II" "Diamond I")
            TIER_NAME="${TIER_NAMES[$TIER-20]}"
          elif [ "$TIER" -le "30" ]; then
            TIER_NAMES=("" "Ruby V" "Ruby IV" "Ruby III" "Ruby II" "Ruby I")
            TIER_NAME="${TIER_NAMES[$TIER-25]}"
          elif [ "$TIER" -eq "31" ]; then
            TIER_NAME="Master"
          else
            TIER_NAME="Unknown"
          fi
          
          # í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ì •ë³´ ì €ì¥
          echo "username=${BOJ_USERNAME}" >> $GITHUB_OUTPUT
          echo "tier_name=${TIER_NAME}" >> $GITHUB_OUTPUT
          echo "solved_count=${SOLVED_COUNT}" >> $GITHUB_OUTPUT
          echo "rank=${RANK}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Update README using GitHub API
        run: |
          # solved.ac í†µê³„ ì„¹ì…˜ ìƒì„±
          STATS_SECTION="## ğŸ“Š solved.ac í†µê³„
          > ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${{ steps.solvedac.outputs.date }}
      
          [![solved.ac í”„ë¡œí•„](https://mazassumnida.wtf/api/v2/generate_badge?boj=rladydgnj)](https://solved.ac/profile/rladydgnj)
      
          ### ê¸°ë³¸ ì •ë³´
          - í‹°ì–´: ${{ steps.solvedac.outputs.tier_name }}
          - í•´ê²°í•œ ë¬¸ì œ ìˆ˜: ${{ steps.solvedac.outputs.solved_count }}ê°œ
          - ë­í‚¹: ${{ steps.solvedac.outputs.rank }}ìœ„"
          
          # í˜„ì¬ README ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
          README_CONTENT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Young4424/BaekJoonCodingTest/contents/README.md" \
            | jq -r .content | base64 --decode)
          
          # ê¸°ì¡´ í†µê³„ ì„¹ì…˜ ì—…ë°ì´íŠ¸ ë˜ëŠ” ì¶”ê°€
          if echo "$README_CONTENT" | grep -q "## ğŸ“Š solved.ac í†µê³„"; then
            NEW_CONTENT=$(echo "$README_CONTENT" | perl -pe 's/## ğŸ“Š solved\.ac í†µê³„.*?(?=\n##|\Z)/$STATS_SECTION/s')
          else
            NEW_CONTENT="${README_CONTENT}\n\n${STATS_SECTION}"
          fi
          
          # í˜„ì¬ README íŒŒì¼ì˜ SHA ê°€ì ¸ì˜¤ê¸°
          SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Young4424/BaekJoonCodingTest/contents/README.md" \
            | jq -r .sha)
          
          # GitHub APIë¥¼ í†µí•´ íŒŒì¼ ì—…ë°ì´íŠ¸
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/Young4424/BaekJoonCodingTest/contents/README.md" \
            -d @- << EOF
          {
            "message": "Update solved.ac statistics",
            "content": "$(echo -n "$NEW_CONTENT" | base64 -w 0)",
            "sha": "$SHA"
          }
          EOF

      - name: Commit and push changes
        run: |
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git commit -m "Update solved.ac statistics"
          
          # ë³€ê²½ì‚¬í•­ í‘¸ì‹œ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push; then
              echo "Successfully pushed changes"
              exit 0
            else
              echo "Push failed, retrying..."
              git pull --rebase
              RETRY_COUNT=$((RETRY_COUNT+1))
            fi
          done
          
          echo "Failed to push changes after $MAX_RETRIES attempts"
          exit 1
