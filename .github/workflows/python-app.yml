name: Update solved.ac Stats

on:
  schedule:
    # Îß§Ïùº Ïò§Ï†Ñ 9Ïãú(KST)Ïóê Ïã§Ìñâ (UTC 0Ïãú)
    - cron: '0 0 * * *'
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ ÏòµÏÖò

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get solved.ac user info and problem stats
        id: solvedac
        run: |
          # BOJ ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÏÑ§Ï†ï
          BOJ_USERNAME="rladydgnj"
          
          # solved.ac APIÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
          USER_INFO=$(curl -s "https://solved.ac/api/v3/user/show?handle=${BOJ_USERNAME}")
          
          # ÌïÑÏöîÌïú Ï†ïÎ≥¥ Ï∂îÏ∂ú
          TIER=$(echo $USER_INFO | jq -r '.tier')
          SOLVED_COUNT=$(echo $USER_INFO | jq -r '.solvedCount')
          RANK=$(echo $USER_INFO | jq -r '.rank')
          
          # Ìã∞Ïñ¥ Ïù¥Î¶Ñ Îß§Ìïë
          if [ "$TIER" -eq "0" ]; then
            TIER_NAME="Unrated"
          elif [ "$TIER" -le "5" ]; then
            TIER_NAMES=("" "Bronze V" "Bronze IV" "Bronze III" "Bronze II" "Bronze I")
            TIER_NAME="${TIER_NAMES[$TIER]}"
          elif [ "$TIER" -le "10" ]; then
            TIER_NAMES=("" "Silver V" "Silver IV" "Silver III" "Silver II" "Silver I")
            TIER_NAME="${TIER_NAMES[$TIER-5]}"
          elif [ "$TIER" -le "15" ]; then
            TIER_NAMES=("" "Gold V" "Gold IV" "Gold III" "Gold II" "Gold I")
            TIER_NAME="${TIER_NAMES[$TIER-10]}"
          elif [ "$TIER" -le "20" ]; then
            TIER_NAMES=("" "Platinum V" "Platinum IV" "Platinum III" "Platinum II" "Platinum I")
            TIER_NAME="${TIER_NAMES[$TIER-15]}"
          elif [ "$TIER" -le "25" ]; then
            TIER_NAMES=("" "Diamond V" "Diamond IV" "Diamond III" "Diamond II" "Diamond I")
            TIER_NAME="${TIER_NAMES[$TIER-20]}"
          elif [ "$TIER" -le "30" ]; then
            TIER_NAMES=("" "Ruby V" "Ruby IV" "Ruby III" "Ruby II" "Ruby I")
            TIER_NAME="${TIER_NAMES[$TIER-25]}"
          elif [ "$TIER" -eq "31" ]; then
            TIER_NAME="Master"
          else
            TIER_NAME="Unknown"
          fi
          
          # ÌòÑÏû¨ ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Ìï¥Í≤∞Ìïú Î¨∏Ï†ú ÌéòÏù¥ÏßÄÎ≥ÑÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
          echo "ÏÇ¨Ïö©ÏûêÍ∞Ä Ìï¥Í≤∞Ìïú Î¨∏Ï†ú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Îäî Ï§ë..."
          
          # Ìã∞Ïñ¥Î≥Ñ Î¨∏Ï†ú Ïàò Ï¥àÍ∏∞Ìôî
          BRONZE_COUNT=0
          SILVER_COUNT=0
          GOLD_COUNT=0
          PLATINUM_COUNT=0
          DIAMOND_COUNT=0
          RUBY_COUNT=0
          
          PAGE=1
          TOTAL_PROBLEMS=0
          
          while true; do
            PROBLEMS=$(curl -s "https://solved.ac/api/v3/search/problem?query=solved_by:${BOJ_USERNAME}&page=${PAGE}")
            COUNT=$(echo $PROBLEMS | jq '.count')
            ITEMS=$(echo $PROBLEMS | jq '.items')
            ITEMS_COUNT=$(echo $ITEMS | jq 'length')
            
            if [ $ITEMS_COUNT -eq 0 ]; then
              break
            fi
            
            # Î¨∏Ï†úÎ≥Ñ Ìã∞Ïñ¥ ÏßëÍ≥Ñ
            for i in $(seq 0 $(($ITEMS_COUNT - 1))); do
              PROBLEM_TIER=$(echo $ITEMS | jq -r ".[$i].level")
              
              if [ $PROBLEM_TIER -ge 1 ] && [ $PROBLEM_TIER -le 5 ]; then
                BRONZE_COUNT=$((BRONZE_COUNT + 1))
              elif [ $PROBLEM_TIER -ge 6 ] && [ $PROBLEM_TIER -le 10 ]; then
                SILVER_COUNT=$((SILVER_COUNT + 1))
              elif [ $PROBLEM_TIER -ge 11 ] && [ $PROBLEM_TIER -le 15 ]; then
                GOLD_COUNT=$((GOLD_COUNT + 1))
              elif [ $PROBLEM_TIER -ge 16 ] && [ $PROBLEM_TIER -le 20 ]; then
                PLATINUM_COUNT=$((PLATINUM_COUNT + 1))
              elif [ $PROBLEM_TIER -ge 21 ] && [ $PROBLEM_TIER -le 25 ]; then
                DIAMOND_COUNT=$((DIAMOND_COUNT + 1))
              elif [ $PROBLEM_TIER -ge 26 ] && [ $PROBLEM_TIER -le 31 ]; then
                RUBY_COUNT=$((RUBY_COUNT + 1))
              fi
            done
            
            TOTAL_PROBLEMS=$((TOTAL_PROBLEMS + ITEMS_COUNT))
            
            if [ $TOTAL_PROBLEMS -ge $COUNT ]; then
              break
            fi
            
            PAGE=$((PAGE + 1))
          done
          
          TOTAL_BY_TIER=$((BRONZE_COUNT + SILVER_COUNT + GOLD_COUNT + PLATINUM_COUNT + DIAMOND_COUNT + RUBY_COUNT))
          
          # Ï†ïÎ≥¥ Ï†ÄÏû•
          echo "username=${BOJ_USERNAME}" >> $GITHUB_OUTPUT
          echo "tier_name=${TIER_NAME}" >> $GITHUB_OUTPUT
          echo "solved_count=${SOLVED_COUNT}" >> $GITHUB_OUTPUT
          echo "rank=${RANK}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "bronze_count=${BRONZE_COUNT}" >> $GITHUB_OUTPUT
          echo "silver_count=${SILVER_COUNT}" >> $GITHUB_OUTPUT
          echo "gold_count=${GOLD_COUNT}" >> $GITHUB_OUTPUT
          echo "platinum_count=${PLATINUM_COUNT}" >> $GITHUB_OUTPUT
          echo "diamond_count=${DIAMOND_COUNT}" >> $GITHUB_OUTPUT
          echo "ruby_count=${RUBY_COUNT}" >> $GITHUB_OUTPUT
          echo "total_by_tier=${TOTAL_BY_TIER}" >> $GITHUB_OUTPUT

      - name: Create new README content
        run: |
          # ÌÜµÍ≥Ñ ÎÇ¥Ïö© ÌååÏùº ÏÉùÏÑ±
          cat > stats_content.md << EOL
          # üß† ÏïåÍ≥†Î¶¨Ï¶ò Î¨∏Ï†ú ÌíÄÏù¥ Ï†ÄÏû•ÏÜå

          ## üìä solved.ac ÌÜµÍ≥Ñ
          > ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: ${{ steps.solvedac.outputs.date }}

          [![solved.ac ÌîÑÎ°úÌïÑ](https://mazassumnida.wtf/api/v2/generate_badge?boj=rladydgnj)](https://solved.ac/profile/rladydgnj)

          ### Í∏∞Î≥∏ Ï†ïÎ≥¥
          - Ìã∞Ïñ¥: ${{ steps.solvedac.outputs.tier_name }}
          - Ìï¥Í≤∞Ìïú Î¨∏Ï†ú Ïàò: ${{ steps.solvedac.outputs.solved_count }}Í∞ú
          - Îû≠ÌÇπ: ${{ steps.solvedac.outputs.rank }}ÏúÑ

          ## üöÄ ÏßÑÌñâ ÏÉÅÌô©
          | ÎÇúÏù¥ÎèÑ | Ìï¥Í≤∞Ìïú Î¨∏Ï†ú Ïàò |
          |:-------:|:-------:|
          | Î∏åÎ°†Ï¶à | ${{ steps.solvedac.outputs.bronze_count }}Î¨∏Ï†ú |
          | Ïã§Î≤Ñ | ${{ steps.solvedac.outputs.silver_count }}Î¨∏Ï†ú |
          | Í≥®Îìú | ${{ steps.solvedac.outputs.gold_count }}Î¨∏Ï†ú |
          | ÌîåÎûòÌã∞ÎÑò | ${{ steps.solvedac.outputs.platinum_count }}Î¨∏Ï†ú |
          | Îã§Ïù¥ÏïÑÎ™¨Îìú | ${{ steps.solvedac.outputs.diamond_count }}Î¨∏Ï†ú |
          | Î£®ÎπÑ | ${{ steps.solvedac.outputs.ruby_count }}Î¨∏Ï†ú |
          | **Ìï©Í≥Ñ** | **${{ steps.solvedac.outputs.total_by_tier }}Î¨∏Ï†ú** |

          EOL
          
          # Í∏∞Ï°¥ README.mdÏóêÏÑú ÌÜµÍ≥Ñ ÏÑπÏÖò Ï†úÍ±∞
          if grep -q "## üìä solved.ac ÌÜµÍ≥Ñ" README.md || grep -q "## üöÄ ÏßÑÌñâ ÏÉÅÌô©" README.md; then
            # ÌÜµÍ≥Ñ ÏÑπÏÖòÍ≥º ÏßÑÌñâ ÏÉÅÌô© ÏÑπÏÖò Ï†úÍ±∞
            awk '
            /^# üß† ÏïåÍ≥†Î¶¨Ï¶ò Î¨∏Ï†ú ÌíÄÏù¥ Ï†ÄÏû•ÏÜå/ { in_header=1; next }
            /^## üìä solved\.ac ÌÜµÍ≥Ñ/,/^##[^#]/ { if (/^##[^#]/ && !/^## üöÄ ÏßÑÌñâ ÏÉÅÌô©/) print; else next }
            /^## üöÄ ÏßÑÌñâ ÏÉÅÌô©/,/^##[^#]/ { if (/^##[^#]/ && !/^## üìä solved\.ac ÌÜµÍ≥Ñ/) print; else next }
            { if (!in_header) print }
            ' README.md > original_content.md
          else
            # Ï≤´ Ï§Ñ(Ï†úÎ™© Ï§Ñ)ÏùÑ Ï†úÏô∏Ìïú ÎÇ¥Ïö© Ï†ÄÏû•
            if grep -q "^# " README.md; then
              sed '1d' README.md > original_content.md
            else
              # Ï†úÎ™© Ï§ÑÏù¥ ÏóÜÏúºÎ©¥ Î™®Îì† ÎÇ¥Ïö© Î≥µÏÇ¨
              cp README.md original_content.md
            fi
          fi
          
          # ÏÉà README ÏÉùÏÑ± (ÌÜµÍ≥Ñ ÎÇ¥Ïö© + Í∏∞Ï°¥ ÎÇ¥Ïö©)
          cat stats_content.md > new_readme.md
          
          # Í∏∞Ï°¥ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
          if [ -s original_content.md ]; then
            echo "" >> new_readme.md
            cat original_content.md >> new_readme.md
          fi
          
          # ÏÉà READMEÎ°ú ÍµêÏ≤¥
          mv new_readme.md README.md

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          
          git add README.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update solved.ac statistics and problem counts"
          git push --force
